{% extends 'base.html' %}

{% block content %}
<style>
  .remote-loading-overlay {
    position: fixed;
    inset: 0;
    background-color: rgba(33, 37, 41, 0.75);
    z-index: 1050;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #fff;
    text-align: center;
    padding: 1.5rem;
  }
</style>
<div id="remote-loading-overlay" class="remote-loading-overlay d-none" role="status" aria-live="polite">
  <div class="spinner-border text-light" role="presentation"></div>
  <p class="mt-3 mb-0" id="remote-loading-text">Procesando…</p>
</div>
<div class="container py-4">
  <h1 class="mb-4">Configurar remote de Rclone</h1>
  <form id="remote-form" class="mt-3" novalidate>
    <div class="row g-3">
      <div class="col-md-6">
        <label for="remote_name" class="form-label">Nombre</label>
        <input type="text" class="form-control" id="remote_name" required placeholder="Ej: gdrive_respaldos">
      </div>
      <div class="col-md-6">
        <label for="remote_type" class="form-label">Tipo</label>
        <select class="form-select" id="remote_type" required>
          <option value="">Seleccione…</option>
          <option value="drive">Google Drive</option>
          <option value="onedrive">OneDrive</option>
          <option value="sftp">SFTP</option>
          <option value="local">Local</option>
        </select>
      </div>
    </div>

    <div id="remote-feedback" class="alert mt-4 d-none" role="alert"></div>

    <div class="mt-4" id="remote-type-panels">
      <div class="remote-panel d-none" data-remote-panel="local">
        <h2 class="h5">Destino local</h2>
        <p class="text-muted">Seleccioná una carpeta preconfigurada del servidor donde se guardarán los respaldos.</p>
        <div class="mb-3">
          <label for="local_path" class="form-label">Carpeta disponible</label>
          <select class="form-select" id="local_path"></select>
        </div>
        <div id="local-empty" class="alert alert-warning d-none" role="alert">
          No hay carpetas locales configuradas. Agregalas en la configuración del contenedor.
        </div>
      </div>

      <div class="remote-panel d-none" data-remote-panel="sftp">
        <h2 class="h5">Servidor SFTP</h2>
        <p class="text-muted">Ingresá los datos de conexión. Primero probamos el acceso y, si es exitoso, podés elegir la carpeta donde se crearán los respaldos.</p>
        <div class="row g-3">
          <div class="col-md-6">
            <label for="sftp_host" class="form-label">Host</label>
            <input type="text" class="form-control" id="sftp_host" placeholder="sftp.ejemplo.com" autocomplete="off">
          </div>
          <div class="col-md-3">
            <label for="sftp_port" class="form-label">Puerto</label>
            <input type="number" class="form-control" id="sftp_port" min="1" max="65535" placeholder="22">
          </div>
          <div class="col-md-6">
            <label for="sftp_username" class="form-label">Usuario</label>
            <input type="text" class="form-control" id="sftp_username" autocomplete="username" placeholder="backup">
          </div>
          <div class="col-md-6">
            <label for="sftp_password" class="form-label">Contraseña</label>
            <input type="password" class="form-control" id="sftp_password" autocomplete="new-password" placeholder="••••••">
          </div>
        </div>
        <div class="form-text mt-2">
          Si dejás el puerto vacío se usará el valor por defecto (22). La carpeta <code>&lt;nombre del remote&gt;</code> se creará automáticamente dentro de la ruta que elijas.
        </div>
        <div class="mt-3">
          <button type="button" class="btn btn-outline-secondary" id="sftp-browse">Establecer conexión y listar carpetas</button>
          <div id="sftp-browser-feedback" class="form-text mt-2 text-muted"></div>
        </div>
        <div id="sftp-browser-panel" class="border rounded p-3 mt-3 d-none">
          <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
            <div><span class="fw-semibold">Carpeta actual:</span> <span id="sftp-current-path">/</span></div>
            <div class="d-flex gap-2 flex-wrap">
              <button type="button" class="btn btn-sm btn-outline-secondary" id="sftp-browser-up" disabled>Subir un nivel</button>
              <button type="button" class="btn btn-sm btn-success" id="sftp-use-current">Usar esta carpeta</button>
            </div>
          </div>
          <div class="mt-3">
            <label for="sftp-directory-select" class="form-label">Subcarpetas disponibles</label>
            <div class="d-flex flex-wrap gap-2 align-items-start">
              <select class="form-select" id="sftp-directory-select" disabled></select>
              <button type="button" class="btn btn-outline-secondary" id="sftp-open-selected">Ver subcarpetas</button>
            </div>
            <div class="form-text mt-2">Elegí una subcarpeta del menú desplegable o usá la carpeta actual para guardar los respaldos.</div>
          </div>
          <div id="sftp-empty" class="alert alert-warning mt-3 d-none" role="alert">
            No encontramos subcarpetas en esta ubicación. Podés usarla igual para guardar los respaldos.
          </div>
        </div>
        <input type="hidden" id="sftp_base_path" value="">
        <div id="sftp-selected-path" class="form-text mt-2 text-muted">
          Todavía no elegiste la carpeta donde se crearán los respaldos.
        </div>
      </div>

      <div class="remote-panel d-none" data-remote-panel="drive">
        <h2 class="h5">Google Drive</h2>
        <p class="text-muted">Elegí cómo querés conectar Google Drive para este remote.</p>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="drive_mode" id="drive_mode_shared" value="shared" checked>
          <label class="form-check-label" for="drive_mode_shared">
            Usar la cuenta provista por el orquestador
          </label>
          <div class="form-text">
            Vamos a crear una carpeta en la cuenta genérica y te daremos un enlace para compartirla.
          </div>
        </div>
        <div id="drive_shared_settings" class="border rounded p-3 mt-3">
          <p class="mb-0">
            Se creará una carpeta llamada <code>&lt;nombre del remote&gt;</code> y, al finalizar, obtendrás un enlace público. Cualquiera con ese link podrá acceder para subir o descargar respaldos.
          </p>
        </div>
        <div class="form-check mt-4">
          <input class="form-check-input" type="radio" name="drive_mode" id="drive_mode_custom" value="custom">
          <label class="form-check-label" for="drive_mode_custom">
            Usar mi propia cuenta de Google Drive
          </label>
          <div class="form-text">
            Vas a necesitar generar un token OAuth con tus credenciales.
          </div>
        </div>
        <div id="drive_custom_settings" class="border rounded p-3 mt-3 d-none">
          <p>Segu&iacute; estos pasos para obtener el token manual:</p>
          <ol>
            <li>Abrí el asistente de rclone para Google Drive desde <a id="drive-doc-link" href="https://rclone.org/drive/" target="_blank" rel="noopener">la documentación oficial</a>.</li>
            <li>Generá un token OAuth siguiendo las instrucciones de rclone.</li>
            <li>Pegá el JSON del token en el campo siguiente y probá la conexión.</li>
          </ol>
          <div class="mb-3">
            <label for="drive_token" class="form-label">Token de acceso</label>
            <textarea id="drive_token" class="form-control" rows="4" placeholder='{"access_token": "..."}'></textarea>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="drive_client_id" class="form-label">Client ID (opcional)</label>
              <input type="text" class="form-control" id="drive_client_id" autocomplete="off" placeholder="123.apps.googleusercontent.com">
              <div class="form-text">Si lo dejás vacío se usará el client ID configurado en el orquestador.</div>
            </div>
            <div class="col-md-6">
              <label for="drive_client_secret" class="form-label">Client secret (opcional)</label>
              <input type="text" class="form-control" id="drive_client_secret" autocomplete="off" placeholder="clave-secreta">
            </div>
          </div>
          <div class="mb-3 mt-3">
            <label for="drive_account_email" class="form-label">Correo de la cuenta (opcional)</label>
            <input type="email" class="form-control" id="drive_account_email" placeholder="miusuario@ejemplo.com" autocomplete="email">
          </div>
          <button type="button" class="btn btn-outline-secondary" id="drive-test-token">Probar token</button>
          <div id="drive-token-feedback" class="form-text mt-2"></div>
        </div>
      </div>

      <div class="remote-panel d-none" data-remote-panel="onedrive">
        <h2 class="h5">OneDrive</h2>
        <div class="alert alert-info" role="alert">
          Integraci&oacute;n en construcci&oacute;n. Pronto vas a poder conectar OneDrive desde aquí.
        </div>
      </div>
    </div>

    <div class="mt-4 d-flex gap-2">
      <button type="submit" class="btn btn-primary" id="remote-submit">Guardar remote</button>
      <button type="button" class="btn btn-outline-secondary d-none" id="remote-cancel-edit">Cancelar edición</button>
    </div>
  </form>

  <div class="mt-5">
    <h2 class="h4">Remotes configurados</h2>
    <p class="text-muted">Consultá los remotes disponibles sin salir de esta página.</p>
    {% include 'partials/remotes_table.html' %}
  </div>

</div>
{% endblock %}
